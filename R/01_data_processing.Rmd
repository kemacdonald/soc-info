---
title: "SOC-INFO data processing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(lubridate); library(magrittr); library(jsonlite); 
library(tidyverse); library(here)
```

```{r}
d_path <- "data/01_raw_data/goal_actions_ver2/pilotB/production-results/"
```

## Load raw json data

Write a function that reads the raw json, extacts the information we care about, and builds a tidy data frame

```{r}
# takes a list and extracts the information we care about
json_to_df <- function(data_path, file) {
  d <- read_json(path = here(data_path, file))
  tibble(
    workerid = d$WorkerId, 
    condition = d$answers$goal_condition,
    music_check_response = d$answers$manip_check_music_response %>% unlist(),
    light_check_response = d$answers$manip_check_light_response %>% unlist(),
    manip_check_order = d$answers$manip_check_order %>% unlist(),
    action_response = d$answers$action_response,
    prior_hypothesis = d$answers$hypotheses_slider_order_prior %>% unlist(),
    prior_beliefs = d$answers$prior_beliefs %>% unlist(),
    posterior_hypothesis = d$answers$hypotheses_slider_order_posterior %>% unlist(),
    posterior_beliefs = d$answers$posterior_beliefs %>% unlist(),
    browser = d$answers$browser,
    browser_width = d$answers$browser_width,
    browser_height = d$answers$browser_height,
    screen_width = d$answers$screen_width,
    screen_height = d$answers$screen_height,
    mobile_device = d$answers$mobile_device,
    about = d$answers$about,
    comment = d$answers$comment,
    age = d$answers$age,
    gender = d$answers$gender,
    first_language = d$answers$language,
    experiment_time = d$answers$experiment_completion_time / 1000,
    action_trial_time = d$answers$action_trial_time / 1000
  )
}
```

Use purrr to map our read json function over all files in the raw data directory

```{r}
files <- dir(here(d_path))
df <- files %>% purrr::map_df(~ json_to_df(data_path = d_path, .)) 
```

## Data checks

How many participants in each condition?

```{r}
df %>% 
  distinct(workerid, condition) %>% 
  count(condition) %>% 
  knitr::kable()
```

Convert all strings to lower case.

```{r}
df %<>% mutate_if(is.character, str_to_lower)
```

## Anonymize Turker ids. 

```{r}
df_anonymized <- df %>% 
  select(workerid) %>% 
  distinct() %>% 
  mutate(id = 1:nrow(.)) 

df_wide <- left_join(df, df_anonymized, by = "workerid") %>% 
  select(id, everything(), -workerid)
```

## Clean up and variable creation

Score the manipulation check.

```{r}
actions <- c("button", "handle", "both")

# some string manipulation to get clean order variable
manip_check <- df_wide %>% 
  select(id, condition, contains("check")) %>% 
  rowwise() %>% 
  mutate(manip_check_order_action = str_sub(manip_check_order, 
                                            start = 1, 
                                            end = str_locate(manip_check_order, "music")[1] - 1)
  )

# score the manipulation check
manip_check %<>% 
  mutate(manip_check_correct = ifelse(music_check_response == manip_check_order_action,
                                    TRUE, FALSE)) %>% 
  group_by(id) %>% 
  mutate(manip_check_score = sum(manip_check_correct)) %>% 
  select(id, condition, manip_check_score) %>% 
  unique()
```

Tidy up the data frame.

```{r}
prior <- df_wide %>% 
  select(id, condition, prior_beliefs, prior_hypothesis) %>% 
  mutate(hypothesis_type = "prior") %>% 
  rename(slider_value = prior_beliefs,
         hypothesis = prior_hypothesis)

posterior <- df_wide %>% 
  select(id, condition, posterior_beliefs, posterior_hypothesis) %>% 
  mutate(hypothesis_type = "posterior") %>% 
  rename(slider_value = posterior_beliefs,
         hypothesis = posterior_hypothesis)

d_final <- bind_rows(prior, posterior) %>% 
  mutate(slider_response_type_collapsed = ifelse(hypothesis == "bothmusiclight", 
                                            "both_actions", 
                                            "single_action"),
         slider_value = as.integer(slider_value))
```

Normalize the sliders.

```{r}
d_final %<>% 
  group_by(id, hypothesis_type) %>% 
  mutate(slider_value_normalized = round(slider_value / sum(slider_value), 3)) %>% 
  ungroup()
```

Create variable that collapses across both single button responses.

```{r}
d_final_collapsed <- d_final %>% 
  group_by(id, hypothesis_type, slider_response_type_collapsed) %>% 
  mutate(slider_value_2 = sum(slider_value)) %>% 
  select(id, hypothesis_type, slider_response_type_collapsed, slider_value_2, condition) %>% 
  unique() %>% 
  group_by(id, hypothesis_type, condition) %>% 
  mutate(slider_value_norm_2 = round(slider_value_2 / sum(slider_value_2), 3)) %>% 
  select(id, hypothesis_type, condition, slider_response_type_collapsed, slider_value_norm_2)
```

Add the second normalized slider variable to the belief data frame.

```{r}
d_final %<>% left_join(., d_final_collapsed,
                       by = c("id", "condition", "hypothesis_type",
                              "slider_response_type_collapsed"))
```

Add participant info.

```{r}
d_final %<>% left_join(., 
                       select(df_wide, id, condition, 
                              browser:action_trial_time) %>% 
                         unique(),
                       by = c("id", "condition"))
```

Add manipulation check info.

```{r}
d_final %<>% left_join(., manip_check, by = c("id", "condition"))
```

Now create a collaposed action response variable and add to the beliefs data frame

```{r}
df_wide %<>% mutate(action_response_collapsed = ifelse(action_response == "both", 
                                                       "both_actions", 
                                                       "single_action"))
```

Now join everything together and create some factor variables in the order we want for plotting.

```{r}
d_final %<>%
  left_join(., select(df_wide, id, condition, 
                      action_response_collapsed, 
                      action_response) %>% 
              unique(),
            by = c("id", "condition")
  )
```

Clean up the hypothesis variable.

```{r}
d_final %<>%
  rowwise() %>% 
  mutate(hypothesis = str_sub(hypothesis, 
                                   start = 1, 
                                   end = str_locate(hypothesis, "music")[1] - 1))
```

## Write to disk. 

```{r}
write_csv(d_final, path = here("/data/02_tidy_data", 
                               "goal_actions_ver2_tidy_pilot.csv"))
```

