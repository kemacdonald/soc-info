---
title: "SOC-INFO Visualization"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Setup

```{r}
library(knitr); library(magrittr); library(tidyverse); library(here)
source(here("R/soc_info_helpers.R"))
```

Read data. 

```{r}
d_path <- "data/03_merged_data"
d_prior <- read_csv(here("data/02_tidy_data/goal_actions_prior_tidy.csv"))
d <- read_csv(here(d_path, "goal_actions_master.csv"))

d %<>% mutate(hypothesis_type = factor(hypothesis_type) %>% fct_rev(),
              hypothesis = factor(hypothesis) %>% fct_rev(),
              condition = fct_recode(condition,
                         "No goal" = "nogoal",
                         "Learning" = "learning",
                         "Performance" = "performance",
                         "Presentation" = "presentation"))
```

## Table of comments

```{r}
d %>% 
  distinct(id, age, condition, social_condition, about) %>% 
  arrange(condition) %>% 
  group_by(condition) %>% 
  sample_n(size = 5) %>% 
  kable()
```


## Data checks and filtering

How many participants in each condition?

```{r}
d %>% 
  distinct(id, condition, social_condition, experiment) %>% 
  count(condition, social_condition, experiment) %>% 
  arrange(experiment, social_condition, condition) %>% 
  kable()
```

How did participants do on the manipulation checks?

```{r}
d %>% 
  distinct(id, manip_check_score) %>% 
  pull(manip_check_score) %>% 
  qplot()
```

How many participants passed the manipulation checks?

```{r}
d %>% 
  filter(manip_check_score >= 2) %>% 
  distinct(id, condition, social_condition, experiment) %>% 
  count(condition, social_condition, experiment) %>% 
  kable()
```

Now filter if the participant got fewer than 3 out of 3 manipulation checks correct. 

```{r}
d %<>% filter(manip_check_score >= 2)
```

## Priors over actions

Make table. 

```{r}
d_prior %>% 
  select(id, action_response, why_action) %>% 
  sample_n(size = 15) %>% 
  kable()
```

Plot distribution over actions.

```{r}  
d_prior %>% 
  count(action_response) %>% 
  mutate(m = n / sum(n)) %>% 
  ggplot(aes(x = action_response, y = m)) +
  geom_bar(stat = "identity", width = 0.4) +
  geom_hline(yintercept = 0.3, linetype = "dashed") +
  lims(y = c(0,0.7)) +
  ggthemes::scale_fill_ptol() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        panel.border = element_rect(fill=NA, size=0.5, color = "grey"))
```

## Experiment 1

```{r}
d_e1 <- filter(d, str_detect(experiment, pattern = "e1"))
```

### Prior and posterior beliefs

Now summarise and plot.
  
```{r}  
d_e1 %>% 
  group_by(hypothesis_type, condition, hypothesis) %>% 
  summarise(m = mean(slider_value_normalized)) %>% 
  ggplot(aes(x = hypothesis, y = m, fill = condition)) +
  geom_bar(stat = "identity", width = 0.4, position = position_dodge()) +
  geom_hline(yintercept = 0.3, linetype = "dashed") +
  lims(y = c(0,0.5)) +
  ggthemes::scale_fill_ptol() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        panel.border = element_rect(fill=NA, size=0.5, color = "grey")) +
  facet_wrap(~hypothesis_type)
```

### Action responses 

Plot counts of different action responses for the learning vs. performance goal conditions.

```{r}
action_plot <- d_e1 %>% 
  distinct(condition, action_response, id) %>%
  count(action_response, condition) %>% 
  group_by(condition) %>% 
  mutate(prop = n / sum(n)) %>% 
  ggplot(aes(x = condition, y = prop, fill = fct_rev(action_response))) +
  geom_bar(stat = "identity", width = 0.4) +
  lims(y = c(0,1)) +
  labs(x = NULL, y = "Prop. Participants", fill = "action response:") +
  #scale_alpha_discrete(range = c(0.4,1)) + 
  ggthemes::scale_fill_ptol() +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        plot.margin=unit(c(1,1,1.5,1.2),"cm")) 
```

Make a table of the raw counts.

```{r}
d_e1 %>% 
  select(condition, action_response, id) %>% 
  unique() %>% 
  count(action_response, condition) %>% 
  arrange(condition, action_response) %>% 
  knitr::kable()
```

### Response times

Plot the distribution of overall time on the experiment across conditions.

```{r}
d_e1 %>% 
  distinct(id, experiment_time, condition) %>% 
  filter(experiment_time <= 2 * sd(experiment_time)) %>% 
  ggplot(aes(x = condition, y = experiment_time / 60)) +
  geom_boxplot(width = 0.3) +
  lims(y = c(0,8)) +
  labs(y = "Time (min)")
```

Make the same plot, but for the time spent on the action decision.

```{r}
rt_plot <- d_e1 %>% 
  distinct(id, action_trial_time, condition, action_response) %>% 
  filter(action_trial_time < mean(action_trial_time) + 2 * sd(action_trial_time),
         action_trial_time > mean(action_trial_time) - 2 * sd(action_trial_time)) %>% 
  ggplot(aes(x = condition, y = action_trial_time)) +
  lims(y = c(0,100)) + 
  geom_violin(fill = NA, draw_quantiles = 0.5, size = 1, trim = T, color = "grey30") + 
  geom_jitter(width = 0.05, shape = 21, alpha = 0.9, color = "grey30", size = 1) + 
  labs(y = c("response time (sec)"), x= NULL) +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm"))
```

## Plot belief change

here we plot belief change as a function of condition and the action that participants chose.

```{r}
d_e1 %>% 
  ggplot(aes(x = hypothesis_type, y = slider_value_normalized, 
             color = action_response)) +
  geom_line(aes(group = id), size = 0.5) + 
  geom_jitter(width = 0, size = 2) +
  lims(y = c(0,1)) +
  labs(x = NULL, y = "Belief") + 
  facet_grid(hypothesis~condition) +
  ggthemes::scale_color_ptol() +
  theme(legend.position = "top",
        panel.border = element_rect(fill=NA, size=0.5, color = "grey"))
```

Get the total belief change for each participant and plot as a function of condition.

```{r fig.width=8, out.width="80%", fig.asp = "0.6"}
d_e1 %>% 
  select(id, condition, hypothesis, hypothesis_type, slider_value_normalized, 
         action_response) %>% 
  spread(key = hypothesis_type, slider_value_normalized) %>% 
  mutate(belief_change = (prior - posterior) %>% abs()) %>% 
  mutate(action_belief = ifelse(action_response == hypothesis, TRUE, FALSE)) %>% 
  filter(action_belief == TRUE) %>% 
  group_by(id, condition, action_response) %>% 
  summarise(ss_m = mean(belief_change)) %>% 
  ggplot(aes(x = action_response, y = ss_m, color = condition)) +
  geom_violin(draw_quantiles = 0.5, trim = T, width = 1, size = 1, 
              adjust = 1, fill = NA) +
  geom_jitter(width = 0.07, alpha = 1, shape = 21, color = "darkgrey") +
  ggthemes::scale_color_ptol() +
  facet_wrap(~condition, ncol = 4) 
```

### Entropy analysis

Compute prior and posterior entropy for each participant, and the entropy change.

```{r}
d_entropy <- d_e1 %>% 
  group_by(id, condition, hypothesis_type, action_response) %>% 
  summarise(entropy_est = compute_entropy(slider_value_normalized)) %>% 
  spread(hypothesis_type, entropy_est) %>% 
  mutate(entropy_change = posterior - prior,
         action_r_collap = ifelse(action_response == "both", "both", "single"))
```

Plot entropy change as a function of condition.

```{r}
entropy_plot <- d_entropy %>% 
  mutate(action_r_collap = ifelse(action_response == "both", "both", "single")) %>% 
  ggplot(aes(x = condition, y = entropy_change, color = fct_rev(action_r_collap),
             fill = fct_rev(action_r_collap))) +
  geom_hline(yintercept = 0, linetype = "solid", color = "grey20") +
  geom_violin(position = position_dodge(width = 1), scale = "width", size = 1,
              draw_quantiles = c(0.5), alpha = 0.3) +
  geom_jitter(alpha = 1, shape = 21, size = 1, 
              position = position_jitterdodge(dodge.width = 1, jitter.width = .05)) +
  ggthemes::scale_color_ptol() +
  ggthemes::scale_fill_ptol() +
  lims(y = c(-1.5, 1.5)) +
  guides(fill = F) + 
  labs(x = NULL, y = "entropy change", color = "action response: ") +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm"))
```

Putting it all together.

```{r}
sub_plots <- cowplot::plot_grid(rt_plot, entropy_plot, labels = c("B", "C"), 
                                ncol = 1,
                                rel_heights = c(0.75,1))

cowplot::plot_grid(action_plot, sub_plots, labels = c("A"),
                   rel_widths = c(1, 0.85))
```


## Experiment 2

```{r}
d_e2 <- filter(d, str_detect(experiment, pattern = "e2"))
```

