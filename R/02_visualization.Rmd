---
title: "SOC-INFO Visualization"
output: html_document
---

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(binom)
library(knitr); library(magrittr); library(tidyverse); library(here); 
library(grid); library(jsonlite); library(ggthemes)
source(here("R/soc_info_helpers.R"))
```

Read data. 

```{r read data}
d_path <- "data/03_merged_data"
d_prior <- read_csv(here("data/02_tidy_data/goal_actions_prior_tidy.csv"))
d_data <- read_csv(here(d_path, "goal_actions_master.csv"))

d_data %<>% mutate(hypothesis_type = factor(hypothesis_type) %>% fct_rev(),
              hypothesis = factor(hypothesis) %>% fct_rev(),
              condition = fct_recode(condition,
                         "No goal \n(Ref)" = "nogoal",
                         "Learning\n" = "learning",
                         "Performance\n" = "performance",
                         "Presentation\n" = "presentation"))
```

## Table of comments

```{r}
d_data %>% 
  distinct(id, age, condition, social_condition, about) %>% 
  arrange(condition) %>% 
  group_by(condition) %>% 
  sample_n(size = 5) %>% 
  kable()
```

## Data checks and filtering

How many participants in each condition?

```{r}
d_data %>% 
  distinct(id, condition, social_condition, experiment) %>% 
  count(condition, social_condition, experiment) %>% 
  arrange(experiment, social_condition, condition) %>% 
  kable()
```

How did participants do on the manipulation checks?

```{r}
d_data %>% 
  distinct(id, manip_check_score) %>% 
  pull(manip_check_score) %>% 
  qplot()
```

How many participants passed the manipulation checks?

```{r}
d_data %>% 
  filter(manip_check_score >= 2) %>% 
  distinct(id, condition, social_condition, experiment) %>% 
  count(condition, social_condition, experiment) %>% 
  kable()
```

Now filter if the participant got fewer than 3 out of 3 manipulation checks correct. 

```{r}
d_data %<>% filter(manip_check_score >= 2)
```

## Priors over actions

Make table. 

```{r}
d_prior %>% 
  select(id, action_response, why_action) %>% 
  sample_n(size = 15) %>% 
  kable()
```

Plot distribution over actions.

```{r}  
d_prior %>% 
  count(action_response) %>% 
  mutate(m = n / sum(n)) %>% 
  mutate(ci_lower = binom.bayes(x = n, n = sum(n), conf.level = 0.95) %>% pull(lower),
         ci_upper = binom.bayes(x = n, n = sum(n), conf.level = 0.95) %>% pull(upper)) %>% 
  ggplot(aes(x = action_response, y = m)) +
  geom_bar(stat = "identity", width = 0.4) +
  geom_linerange(aes(ymin=ci_lower,ymax=ci_upper), alpha = 0.3) +
  geom_hline(yintercept = 0.3, linetype = "dashed") +
  lims(y = c(0,0.7)) +
  ggthemes::scale_fill_ptol() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        panel.border = element_rect(fill=NA, size=0.5, color = "grey"))
```

## Experiment 1

```{r e1 filter}
d_e1 <- filter(d_data, str_detect(experiment, pattern = "e1"))
```

### Prior and posterior beliefs

Now summarise and plot.

```{r}  
d_e1 %>% 
  group_by(hypothesis_type, condition, hypothesis) %>% 
  summarise(m = mean(slider_value_normalized)) %>% 
  ggplot(aes(x = hypothesis, y = m, fill = condition)) +
  geom_bar(stat = "identity", width = 0.4, position = position_dodge()) +
  geom_hline(yintercept = 0.3, linetype = "dashed") +
  lims(y = c(0,0.5)) +
  ggthemes::scale_fill_ptol() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        panel.border = element_rect(fill=NA, size=0.5, color = "grey")) +
  facet_wrap(~hypothesis_type)
```

### Action responses 

Plot counts of different action responses for the learning vs. performance goal conditions.

```{r get prop credible intervals e1}
hpd_ref <- d_e1 %>% 
  distinct(id, condition, action_r_collap) %>%
  group_by(condition) %>% 
  mutate(n_participants = n()) %>% 
  count(action_r_collap, n_participants, condition) %>% 
  filter(action_r_collap == "single") 

hpd <- hpd_ref %>% 
  split(.$condition) %>%
  map_df(~ binom.bayes(x = .$n, n = .$n_participants, conf.level = 0.95))

hpd_final <- bind_cols(hpd_ref, hpd)
```

```{r make action plot e1}
action_plot_e1 <- d_e1 %>% 
  distinct(condition, action_r_collap, id) %>%
  count(action_r_collap, condition) %>% 
  group_by(condition) %>% 
  mutate(prop = n / sum(n)) %>% 
  filter(action_r_collap == "single") %>%
  # ggplot(aes(x = condition, y = prop, fill = action_r_collap, alpha = action_r_collap)) +
  ggplot(aes(x = condition, y = prop)) +
  geom_bar(stat = "identity", width = 0.4) +
  geom_linerange(aes(x = condition, ymin = lower, ymax = upper), inherit.aes = F,
                 color = "black", alpha = 0.6, size = 1,
                 data = hpd_final) +
  lims(y = c(0,1)) +
  guides(alpha = F) +
  scale_alpha_discrete(range = c(0.6, 1)) +
  scale_fill_grey(start = 0.1, end = 0.6)+ 
  # ggthemes::scale_fill_ptol() +
  labs(x = NULL, y = "Prop. participants choosing single action", fill = "action response:") +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1),"cm"),
        text = element_text(size = 12),
        axis.text.x.top = element_text(vjust = -0.5)) 

action_plot_e1
```

Make a table of the raw counts.

```{r}
d_e1 %>% 
  select(condition, action_response, id) %>% 
  unique() %>% 
  count(action_response, condition) %>% 
  arrange(condition, action_response) %>% 
  knitr::kable()
```

### Response times

time spent on the action decision.

```{r}
rt_plot <- d_e1 %>% 
  distinct(id, action_trial_time, condition, action_response) %>% 
  filter(action_trial_time < mean(action_trial_time) + 2 * sd(action_trial_time),
         action_trial_time > mean(action_trial_time) - 2 * sd(action_trial_time)) %>% 
  ggplot(aes(x = condition, y = action_trial_time)) +
  lims(y = c(0,100)) + 
  geom_jitter(width = 0.04, shape = 21, alpha = 0.9, color = "black", size = 1) + 
  geom_boxplot(position = position_dodge(width = 0.3), alpha = 0.7, width = 0.3,
               color = "grey10", outlier.shape = NA, fill = "grey10") +
  labs(y = c("response time (sec)"), x= NULL) +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm"),
        text = element_text(size = 12))
```

## Plot belief change

here we plot belief change as a function of condition and the action that participants chose.

```{r}
d_e1 %>% 
  ggplot(aes(x = hypothesis_type, y = slider_value_normalized, 
             color = action_response)) +
  geom_line(aes(group = id), size = 0.5) + 
  geom_jitter(width = 0, size = 2) +
  lims(y = c(0,1)) +
  labs(x = NULL, y = "Belief") + 
  facet_grid(hypothesis~condition) +
  ggthemes::scale_color_ptol() +
  theme(legend.position = "top",
        panel.border = element_rect(fill=NA, size=0.5, color = "grey"))
```

Get the total belief change for each participant and plot as a function of condition.

```{r fig.width=8, out.width="80%", fig.asp = "0.6"}
d_e1 %>% 
  select(id, condition, hypothesis, hypothesis_type, slider_value_normalized, 
         action_response) %>% 
  spread(key = hypothesis_type, slider_value_normalized) %>% 
  mutate(belief_change = (prior - posterior) %>% abs()) %>% 
  mutate(action_belief = ifelse(action_response == hypothesis, TRUE, FALSE)) %>% 
  filter(action_belief == TRUE) %>% 
  group_by(id, condition, action_response) %>% 
  summarise(ss_m = mean(belief_change)) %>% 
  ggplot(aes(x = action_response, y = ss_m, color = condition)) +
  geom_violin(draw_quantiles = 0.5, trim = T, width = 1, size = 1, 
              adjust = 1, fill = NA) +
  geom_jitter(width = 0.07, alpha = 1, shape = 21, color = "darkgrey") +
  ggthemes::scale_color_ptol() +
  facet_wrap(~condition, ncol = 4) 
```

## Entropy analysis

Here, we use KL-divergence as our measure of entropy change computation that takes into account where the participant started (prior beliefs). 

```{r score ig for each participant}
d_e1 %<>%
  split(.$id) %>%
  map_df(ig)
```

Plot entropy change as a function of condition.

```{r entropy_plot_violin_e1, eval = F}
entropy_plot <- d_e1 %>% 
  mutate(action_r_collap = fct_relevel(action_r_collap, "single")) %>%
  distinct(id, condition, social_condition, entropy_change, action_r_collap) %>% 
  ggplot(aes(x = condition, y = entropy_change, color = action_r_collap,
             fill = action_r_collap)) +
  # geom_hline(yintercept = 0, linetype = "solid", color = "grey20") +
  geom_hline(yintercept = -1.5, linetype = "solid", color = "grey20") +
  geom_violin(position = position_dodge(width = 1), scale = "width", size = 1,
              draw_quantiles = c(0.5), alpha = 0.3) +
  geom_jitter(alpha = 1, shape = 21, size = 1, 
              position = position_jitterdodge(dodge.width = 1, jitter.width = .05)) +
  ggthemes::scale_color_ptol() +
  ggthemes::scale_fill_ptol() +
  # lims(y = c(-1.5, 1.5)) +
  guides(fill = F) + 
  labs(x = NULL, y = "entropy change", color = "action response: ") +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm"), 
        text = element_text(size = 12))
```

```{r entropy_plot boxplot e1}
entropy_plot <- d_e1 %>% 
  distinct(id, condition, social_condition, ig, action_r_collap) %>% 
  ggplot(aes(x = condition, y = ig, color = fct_rev(action_r_collap),
             fill = fct_rev(action_r_collap))) +
  geom_hline(yintercept = 0, linetype = "solid", color = "grey20") +
  geom_jitter(alpha = 0.85, shape = 21, size = 1, 
              position = position_jitterdodge(dodge.width = 0.3, jitter.width = .05)) +
  geom_boxplot(position = position_dodge(width = 0.3), alpha = 0.7, width = 0.3,
               color = "grey10", outlier.colour = "white") +
  ggthemes::scale_color_ptol() +
  ggthemes::scale_fill_ptol() +
  lims(y = c(-2, 2)) +
  guides(color = F) +
  labs(x = NULL, y = "entropy change", fill = "action response: ") +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm"))
```

Putting it all together.

```{r}
sub_plots <- cowplot::plot_grid(rt_plot, entropy_plot, labels = c("B", "C"), 
                                ncol = 1,
                                rel_heights = c(0.7,1))

e1_plot <- cowplot::plot_grid(action_plot_e1, sub_plots, labels = c("A"),
                              rel_widths = c(1, 0.9))
```

Save figure.

```{r}
# ggsave("e1_plot.png", plot = e1_plot, width = 10, height = 4.5,
#         path = here::here("writing/cogsci2018/figs"))
```

## Experiment 2

```{r}
d_e2 <- filter(d_data, str_detect(experiment, pattern = "e2"))
```

Action plot

```{r get prop credible intervals e2}
hpd_e2 <- d_e2 %>% 
  distinct(id, condition, social_condition, action_r_collap) %>%
  group_by(condition, social_condition) %>% 
  mutate(n_participants = n()) %>% 
  count(action_r_collap, n_participants, condition, social_condition) %>% 
  filter(action_r_collap == "single") %>% 
  rowwise() %>%
  mutate(lower = binom.bayes(x = n, n = n_participants, conf.level = 0.95) %>% pull(lower),
         upper = binom.bayes(x = n, n = n_participants, conf.level = 0.95) %>% pull(upper)) 
```

```{r make action plot e2}
action_plot_e2 <- d_e2 %>% 
  distinct(condition, social_condition, action_r_collap, id) %>%
  count(action_r_collap, condition, social_condition) %>% 
  group_by(condition, social_condition) %>% 
  mutate(prop = n / sum(n)) %>% 
  filter(action_r_collap == "single") %>% 
  ggplot(aes(x = condition, y = prop, fill = social_condition)) +
  geom_bar(stat = "identity", width = 0.6, position = position_dodge()) +
  geom_linerange(aes(x = condition, ymin = lower, ymax = upper, 
                     group = social_condition), inherit.aes = F,
                 color = "grey50", alpha = 0.6, size = 1,
                 position = position_dodge(width = 0.6),
                 data = hpd_e2) +
  lims(y = c(0,1)) +
  labs(x = NULL, y = "Prop. participants choosing single action", fill = "context:") +
  scale_fill_grey(start = 0.1, end = 0.6)+ 
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1.2,0.5,1),"cm"))

action_plot_e2
```

```{r bda}
load(here("model/BDA/e2/results/soc-info-ver1-mcmc100000_burn50000_4chains.RData"))
```

```{r make action plot e2 w bda}
d_e2_temp <- jsonlite::fromJSON(here::here("model/BDA/e2/e2-actionData.json"))

d_e2_pred <- d_e2_temp %>% 
  mutate(action = fct_recode(action, 
                             "single" = "button",
                             "single" = "handle")) %>%
  # filter(action == "both") %>%
  mutate(context = fct_recode(factor(obsPres),
                              "social" = "1",
                              "no-social" = "0"
  )) %>%  
  mutate(goal = fct_recode(goal, "no goal" = "noGoal")) %>%
  distinct(goal, context, action, id) %>%
  count(action, goal, context) %>% 
  group_by(goal, context) %>% 
  mutate(prob = n / sum(n)) %>% 
  mutate(ci_lower = binom.bayes(x = n, n = sum(n), conf.level = 0.95) %>% pull(lower),
         ci_upper = binom.bayes(x = n, n = sum(n), conf.level = 0.95) %>% pull(upper)) %>% 
  filter(action == "single") %>%
  select(-n)

postpred <- d %>% 
  mutate(action = fct_recode(action, 
                             "single" = "button",
                             "single" = "handle")) %>%
  filter(grepl("posterior", parameter),
         action == "both") %>%
  filter(!(goal == "presentation" & obsPres == "0")) %>%
  group_by(goal, context, action) %>%
  summarise(prob = mean(1-value),
            ci_lower = hdi_lower(1-value),
            ci_upper = hdi_upper(1-value)
            ) 

data_mod <- rbind(postpred %>% mutate(source = "model"), 
                  d_e2_pred %>% mutate(source = "data")) %>%
  ungroup() %>%
  mutate(goal = fct_recode(goal,
                           "Learning\n" = "learning",
                           "No goal \n(Ref)" = "no goal",
                           "Performance\n" = "performance",
                           "Presentation\n" = "presentation"
                           ))

data_mod_comp <- ggplot(data_mod, aes(x = goal, y = prob, fill = context)) +
  geom_bar(stat = "identity", width = 0.6, position = position_dodge()) +
  geom_linerange(aes(x = goal, ymin = ci_lower, ymax = ci_upper, 
                     group = context), inherit.aes = F,
                 color = "grey50", alpha = 0.6, size = 1,
                 position = position_dodge(width = 0.6)) +
  lims(y = c(0,1)) +
  labs(x = NULL, y = "Prop. participants choosing single action", fill = "context:") +
  scale_fill_grey(start = 0.1, end = 0.6)+ 
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1.2,0.5,1),"cm")) +
  facet_grid(source~.)
```

RT plot

```{r rt plot e2}
e2_rt_plot <- d_e2 %>% 
  distinct(id, action_trial_time, condition, social_condition) %>% 
  filter(action_trial_time < mean(action_trial_time) + 2 * sd(action_trial_time),
         action_trial_time > mean(action_trial_time) - 2 * sd(action_trial_time)) %>% 
  ggplot(aes(x = condition, y = action_trial_time)) +
  lims(y = c(0,100)) + 
  geom_jitter(width = 0.04, shape = 21, alpha = 0.9, color = "black", size = 1) + 
  geom_boxplot(position = position_dodge(width = 0.3), alpha = 0.7, width = 0.3,
               color = "grey10", outlier.shape = NA, fill = "grey10") +
  labs(y = c("response time (sec)"), x= NULL) +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm")) 
```

### Entropy change

```{r entropy plot violin e2, eval = F}
e2_ent_plot <- d_e2 %>% 
  distinct(id, condition, social_condition, entropy_change, action_r_collap) %>% 
  ggplot(aes(x = condition, y = entropy_change, color = fct_rev(action_r_collap),
             fill = fct_rev(action_r_collap))) +
  geom_hline(yintercept = 0, linetype = "solid", color = "grey20") +
  geom_violin(position = position_dodge(width = 1), scale = "width", size = 1,
              draw_quantiles = c(0.5), alpha = 0.3) +
  geom_jitter(alpha = 1, shape = 21, size = 1, 
              position = position_jitterdodge(dodge.width = 1, jitter.width = .05)) +
  ggthemes::scale_color_ptol() +
  ggthemes::scale_fill_ptol() +
  lims(y = c(-1.5, 1.5)) +
  guides(fill = F) +
  labs(x = NULL, y = "entropy change", color = "action response: ") +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm"))
```

Here, we use KL-divergence as our measure of entropy change computation that takes into account where the participant started (prior beliefs). 

```{r score ig for each participant}
d_e2 <- d_e2 %>%
  split(.$id) %>%
  map_df(ig)
```

```{r e2 entropy kl plot}
e2_ent_plot <- d_e2 %>% 
  distinct(id, condition, social_condition, ig, action_r_collap) %>% 
  ggplot(aes(x = condition, y = ig, color = fct_rev(action_r_collap),
             fill = fct_rev(action_r_collap))) +
  geom_hline(yintercept = 0, linetype = "solid", color = "grey20") +
  geom_jitter(alpha = 0.85, shape = 21, size = 1, 
              position = position_jitterdodge(dodge.width = 0.3, jitter.width = .05)) +
  geom_boxplot(position = position_dodge(width = 0.3), alpha = 0.7, width = 0.3,
               color = "grey10", outlier.colour = "white") +
  ggthemes::scale_color_ptol() +
  ggthemes::scale_fill_ptol() +
  lims(y = c(-2, 2)) +
  guides(color = F) +
  labs(x = NULL, y = "entropy change", fill = "action response: ") +
  theme(panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin=unit(c(0.5,1,0.5,1.2),"cm"))
```

### BDA model-data fits

```{r bda phi}
d_phi <- d %>%
  filter(grepl("phi", parameter)) %>%
  filter(!(goal == "presentation" & context == "no-social")) %>%
  group_by(parameter, goal, context) %>%
  summarise(mean = mean(value),
            ci_lower = hdi_lower(value),
            ci_upper = hdi_upper(value)) %>%
  ungroup() %>%
  mutate(phi = fct_recode(parameter,
                          "learning" = "phiLearning",
                          "performance" = "phiPerformance",
                          "presentation" = "phiPresentation"
  )) %>% mutate(priority = fct_recode(phi,
                               "exploration" = "learning",
                               "exploitation" = "performance", 
                               "exploitation" = "presentation"
  ))

d_phi_exploit <- d_phi %>%
  mutate(mean = case_when(priority == "exploration" ~ "0", 
                          TRUE ~ as.character(as.numeric(mean)))) %>%
  mutate(mean = as.numeric(as.character(mean)))

d_phi_explore <- d_phi %>%
  mutate(mean = case_when(priority == "exploitation" ~ "0", 
                          TRUE ~ as.character(as.numeric(mean)))) %>%
  mutate(mean = as.numeric(as.character(mean)))

phi <- d_phi %>%
  ggplot(., aes(x = interaction(context, goal), y = mean, fill = phi, 
                group = phi, order=phi)) +
  geom_bar(data=d_phi_exploit,
           stat="identity", width=.3, position = position_stack(reverse = TRUE)) +
  geom_bar(data=d_phi_explore,
           position=position_nudge(x=-.3), stat="identity", width=.3) +
  ylim(0,1) +
  # annotate(geom = "text", label = d_phi$context) +
  # annotate(geom = "text", label = unique(d_phi$goal)) +
  ggthemes::scale_fill_ptol() +
  ylab("phi value") +
  xlab(NULL) +
  theme_few() +
  scale_x_discrete(position = "bottom", 
                   labels = c("no-social\nlearning", "social\nlearning", 
                              "no-social\nno-goal", "social\nno-goal",
                              "no-social\nperformance", "social\nperformance",
                              "social\npresentation")) +
  labs(x = NULL, y = "phi value", color = "action response: ") +
  theme(
    axis.text.x = element_text(vjust=1, hjust=0.8, angle=35, size=8),
    # axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_rect(fill=NA, size=0.5, color = "grey"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    plot.margin=unit(c(0.5,1,0.5,1.2),"cm"),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.text=element_text(size=8))
```

```{r}
sub_plots_e2 <- cowplot::plot_grid(e2_rt_plot, e2_ent_plot, phi, 
                                   labels = c("B", "C", "D"), 
                                   ncol = 1,
                                   rel_heights = c(0.7,0.8, 1))

e2_plot <- cowplot::plot_grid(data_mod_comp, sub_plots_e2, labels = c("A"),
                              rel_widths = c(1, 1))
```

```{r}
# ggsave("e2_plot.png", plot = e2_plot, width = 10, height = 4.5,
       # path = here::here("writing/cogsci2018/figs"))
```

