---
title: "BDA_ana"
author: "Erica Yoon"
date: "1/24/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(jsonlite)
library(langcog)
library(ggthemes)
library(coda)


estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}
hdi_upper <- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}
hdi_lower <- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}
options("scipen"=10)   
```

```{r jsonToDataFrame}
# bda1 <- fromJSON(here("model/BDA/results/soc-info-ver1-mcmc100000_burn50000_chain1.json"), flatten = TRUE, simplifyDataFrame = TRUE)
# bda2 <- fromJSON(here("model/BDA/results/soc-info-ver1-mcmc100000_burn50000_chain2.json"), flatten = TRUE, simplifyDataFrame = TRUE)
# bda3 <- fromJSON(here("model/BDA/results/soc-info-ver1-mcmc100000_burn50000_chain3.json"), flatten = TRUE, simplifyDataFrame = TRUE)
# bda4 <- fromJSON(here("model/BDA/results/soc-info-ver1-mcmc100000_burn50000_chain4.json"), flatten = TRUE, simplifyDataFrame = TRUE)
# 
# d <-
#   rbind(bda1$support %>%
#              mutate(chain = 1),
#            bda2$support %>%
#              mutate(chain = 2),
#            bda3$support %>%
#              mutate(chain = 3),
#            bda4$support %>%
#              mutate(chain = 4)
#         ) %>%
#   gather(parameter, value, -chain) %>%
#   separate(parameter, c("parameter", "goal", "obsPres", "action")) %>%
#   mutate(goal = fct_recode(goal,
#                            "no goal" = "noGoal"),
#          context = fct_recode(obsPres,
#                               "social" = "1",
#                               "no-social" = "0"
#                               ))
# 
# save(d, file=here("model/BDA/results/soc-info-ver1-mcmc100000_burn50000_4chains.RData"))

load(here("model/BDA/results/soc-info-ver1-mcmc100000_burn50000_4chains.RData"))
```

```{r phi and beta}
d %>%
  filter(grepl("phi", parameter)) %>%
  filter(!(goal == "presentation" & context == "no-social")) %>%
  group_by(parameter, goal, context) %>%
  summarise(mean = mean(value)) %>%
  ungroup() %>%
  mutate(phi = fct_recode(parameter,
                          "learning" = "phiLearning",
                          "performance" = "phiPerformance",
                          "presentation" = "phiPresentation"
                          )) %>%
  ggplot(., aes(x = goal, y = mean, fill = phi)) +
  geom_bar(position="dodge", stat="identity") +
  facet_grid(.~context, labeller=label_both) +
  ylim(0,1) +
  scale_fill_solarized() +
  ylab("phi value")

```

```{r optimality}
d %>%
  filter(grepl("optimal", parameter)) %>%
  ggplot(., aes(value)) +
  geom_density() +
  theme_few()

optimality <- d %>% 
  filter(grepl("optimal", parameter)) %>%
  group_by(parameter) %>%
  summarise(ci_lower = round(hdi_lower(value),2),
            ci_upper = round(hdi_upper(value),2),
            mean = round(mean(value),2))

```

```{r action}
d %>% 
  mutate(action = fct_recode(action, 
                             "single" = "button",
                             "single" = "handle")) %>%
  filter(grepl("posterior", parameter),
         action != "both") %>%
  filter(!(goal == "presentation" & obsPres == "0")) %>%
  group_by(goal, context, action) %>%
  summarise(prob = mean(value)) %>%
  ggplot(., aes(x = goal, y=prob, fill=context)) +
  geom_bar(stat="identity", position="dodge") +
  theme_few() +
  scale_fill_solarized() +
  ylab("predicted likelihood of choosing 'single' action")
```
